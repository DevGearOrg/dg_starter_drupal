# DevGear Drupal Starter

DevGear стартовый набор для Drupal проэктов с использованием Docker.  
За основу взят проэкт [wodby/docker4drupal](https://github.com/wodby/docker4drupal) но максимально упрощен.

*Читай это на других языках: [English](README.md), [Русский](README.ru.md).*

## Требования:

Мы используем минимальный набор универсальных инструментов, который необходимо подготовить:

1. Усановить Docker и docker-compose для своей операционной системы: [Docker for Developers](https://www.docker.com/get-started)
2. Убедиться что команда `make` работает или установить GNU Make. `Makefile` можно использовать как шпаргалку.

## Быстрый старт (новый код):

1. Создаем директорию локально для нового проекта с содержимым текущего репозитория.
2. Правим файл `.env`, указываем название проекта (PROJECT_NAME) и др.
3. Запускаем команду `make new` с этой диреткории и ждем завершения.
4. Проверяем http://localhost/

## Быстрый старт (свой код):

1. Создаем директорию локально для нового проекта с содержимым текущего репозитория.
2. Правим файл `.env`, указываем название проекта (PROJECT_NAME) и др.
3. Копируем исходный код проекта в `public_html` директорию, правим `settings.php`.
4. Запускаем `make run`
5. Импортируем БД (можно через PMA если открыть комментарий в `docker-compose.yml`)
6. Проверяем http://localhost/

## Команды в Makefile:

- `make run`  - обертка вокруг `docker-compose up`. Подготавливает контейнеры и запускает.
- `make up`  - аналогочно `make run` но запускает в режиме демона (не захватывает терминал).
- `make stop` - останавливает все контейнеры.
- `make restart` - перезапускает контейнеры. `make stop` + `make up`
- `make prune` - останавливает контейнеры и удаляет контейнеры-хранилища (напр. БД)
- `make clear` - аналогично `make prune` но и удаляет образы.
- `make ps` - как `docker ps` выводит список и статус контейнеров приложения.
- `make drush` - выполянет команду `drush` внутри php контейнера, можно предавать аргменты.
- `make logs` - в случее запуска как демон подключается к потоку логов всех контейнеров.
- `make shell` - заходит в `bash` php контейнера. Более практичный вариант выполнения drush.
- `make new` - удаляет все если есть и создает новый `drupal-7` проект по `.env`.
- `make backup` - создает дамп БД в папке `./tmp`, имя файла сожержит дату.

## Планы на развитие:
1. Команды для создания бекапа всего проекта и восстановления с бекапа.
2. Команды на создания удаленного бекапа и восстановления.
3. Обновление проекта на сервере (бекап локального и рестор удаленного).

## Возможные проблемы:
1. `make drush` не выполняется.   
Не все команды можно выполнить потобным образом, к примеру ключи-аргументы передаются не все. Как решение можно использовать запуск из шела: `make shell`.
2. `make run` выдает ошибку `port is already allocated`.  
Это означает что один из портов уже занят и повторно его использовать нельзя. Решение: проверить наличие запущенных контейнеров `make ps` или `docker ps`. Остановить те, которые не используются. Часто помогает `make restart`.
3. Приложение не запускается и выдает 5хх ошибки "Internal Server Error".  
Смотреть логи вывода сервер контейнера. Отображаются или в терминале где запущен сервер или командой `make logs` если в режиме демона. Например наличие `Invalid command 'php_flag'` может указыват на неправильный конфиг apache (.htaccess) и тд.
4. Приложение запускается но сообщает о проблемах.  
Зависит от приложения, каждый случай требует особого внимания (отладки). К примеру если упоминается `DatabaseConnection` то в первую очередь следует проверить конфигурацию коннекта к базе данных (settings.php совпадает с .env).

## Дополнительные вопросы:
1. Как быстро импортировать дамп sql (база данных)?  
Выполняем команду drush:
`make drush sql-cli < ./tmp/my_dump.sql`. Путь указываем относительно текущей директории своей ос.
2. Есть более удбный способ создавать новый проект, не копируя zip руками?  
Todo...